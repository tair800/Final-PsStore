@model UserBasketVM
<script src="https://js.stripe.com/v3/"></script>

<h2>Checkout</h2>
<div id="basketItems">
    <!-- Display the basket items here using your model -->
    <ul>
        @foreach (var game in Model.BasketGames)
        {
            <li>@game.GameTitle - @game.Price</li>
        }
    </ul>
</div>

<form id="payment-form">
    <div id="card-element">
        <!-- Stripe's Card Element will be inserted here -->
    </div>
    <button type="submit" id="submit">Pay</button>
</form>

<div id="payment-message" class="hidden"></div>

<script>
    const stripe = Stripe('your-publishable-key'); // Replace with your actual publishable key from Stripe
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const { error, paymentMethod } = await stripe.createPaymentMethod({
            type: 'card',
            card: cardElement,
        });

        if (error) {
            // Handle error in UI
            console.error(error);
            document.getElementById('payment-message').innerText = error.message;
            return;
        }

        // Send paymentMethod.id to the server for further processing
        const response = await fetch('/Basket/PlaceOrder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]').value,
            },
            body: JSON.stringify({
                paymentMethodId: paymentMethod.id
            })
        });

        if (response.ok) {
            window.location.href = '/Basket/OrderSuccess';
        } else {
            document.getElementById('payment-message').innerText = 'Payment failed';
        }
    });
</script>
