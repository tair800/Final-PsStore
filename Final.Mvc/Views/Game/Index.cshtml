@using Final.Mvc.ViewModels.GameVMs
@model List<GameListItemVM>

@section Links {
    <link href="~/css/game.css" rel="stylesheet" />
}

<div class="page-container">
    <h1 class="mb-4">All Games</h1>
    <div class="row">
        <!-- Filtering Options -->
        <div class="col-12 col-md-3 mb-4">
            <div class="filter-container">
                <form method="get" asp-action="Index">
                    <!-- Category Filter -->
                    <div class="mb-3">
                        <label for="filterCategory" class="form-label">Category</label>
                        <select id="filterCategory" name="category" class="form-select">
                            <option value="">All Categories</option>
                            @foreach (var category in Model)
                            {
                                <option value="@category.CategoryId">@category.CategoryName</option>
                            }
                        </select>
                    </div>

                    <!-- Platform Filter -->
                    <div class="mb-3">
                        <label for="filterPlatform" class="form-label">Platform</label>
                        <select id="filterPlatform" name="platform" class="form-select">
                            <option value="">All Platforms</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </form>
            </div>
        </div>

        <!-- Games Display -->
        <div class="col-12 col-md-9">
            <div class="row">
                @foreach (var game in Model)
                {
                    <div class="col-12 col-sm-6 col-lg-4 game-card-container">
                        <div class="game-card">
                            <img src="./img/gta.jpg" alt="@game.Title">
                            <button class="favorite-btn">
                                <i class="fas fa-heart"></i>
                            </button>

                            <!-- Platform Labels -->
                            <div class="platform-labels">
                                @if ((int)game.Platform == 1)
                                {
                                    <div class="platform-label bg-white text-dark">PS5</div>
                                }
                                else if (game.Platform == 0)
                                {
                                    <div class="platform-label bg-dark text-light">PS4</div>
                                }
                                else if ((int)game.Platform == 2)
                                {
                                    <div class="platform-label bg-white text-dark">PS5</div>
                                    <div class="platform-label bg-dark text-light">PS4</div>
                                }
                            </div>

                            <div class="game-info">
                                <div class="game-title">@game.Title</div>

                                <!-- Display discounted price if applicable -->
                                <div class="game-price">
                                    @if (game.SalePrice.HasValue)
                                    {
                                        <span class="original-price text-decoration-line-through">$@game.Price</span>
                                        <span class="discount-price">$@game.SalePrice</span>
                                    }
                                    else
                                    {
                                        <span class="regular-price">$@game.Price</span>
                                    }
                                </div>
                            </div>
                            <button class="add-to-cart-btn" onclick="addToBasket('@game.Id')">Add to Cart</button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Function to extract JWT token from cookies
        function getJwtTokenFromCookie() {
            const cookieString = document.cookie;
            const cookies = cookieString.split('; ');
            const tokenCookie = cookies.find(row => row.startsWith('token='));
            return tokenCookie ? tokenCookie.split('=')[1] : null;
        }

        // Function to decode JWT token and extract the payload
        function decodeJwtToken(token) {
            if (!token) return null;
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

        // Function to add a game to the basket
        function addToBasket(gameId) {
            const token = getJwtTokenFromCookie(); // Get the token from cookies
            const decodedToken = decodeJwtToken(token); // Decode the JWT token
            const email = decodedToken ? decodedToken.email : null; // Extract the email from the token

            if (!email) {
                alert("Please sign in to add items to the basket.");
                return;
            }

            $.ajax({
                url: '@Url.Action("AddToBasket", "Basket")', // Use your MVC Basket controller
                type: 'POST',
                data: {
                    email: email,  // Send the decoded email
                    gameId: gameId,
                    quantity: 1  // Default quantity is 1
                },
                success: function (result) {
                    alert('Game added to basket!');
                },
                error: function (xhr, status, error) {
                    alert('Failed to add game to basket.');
                }
            });
        }
    </script>
}
